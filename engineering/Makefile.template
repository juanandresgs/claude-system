# Engineering Ethos Makefile Template
# Enhanced automation for systematic engineering practices
# Version: 2.0 - Evidence-based with pattern integration

# Configuration - Override in local Makefile if needed
PROJECT_NAME ?= $(shell basename $(CURDIR))
CLAUDE_GLOBAL ?= $(HOME)/.claude
NODE_VERSION ?= 18
TEST_TIMEOUT ?= 30000

# Color output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
PURPLE := \033[0;35m
NC := \033[0m

# Default target
.PHONY: help
help: ## Show this help message
	@echo "$(BLUE)Engineering Ethos Makefile - $(PROJECT_NAME)$(NC)"
	@echo ""
	@echo "$(GREEN)Core Engineering Commands:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(BLUE)%-15s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)Engineering Ethos Four Pillars:$(NC)"
	@echo "  1. $(PURPLE)Learnings-First Development$(NC) - Always consult LEARNINGS.md"
	@echo "  2. $(PURPLE)Test-Driven Protection$(NC) - Critical paths require 100% coverage"
	@echo "  3. $(PURPLE)Documentation-as-Code$(NC) - Keep documentation current"
	@echo "  4. $(PURPLE)Proactive Architecture$(NC) - Think deep, implement prevention"

# Setup and Installation
.PHONY: setup
setup: ## Initialize Engineering Ethos for this project
	@echo "$(BLUE)üèóÔ∏è Setting up Engineering Ethos for $(PROJECT_NAME)...$(NC)"
	@if [ -f "$(CLAUDE_GLOBAL)/engineering/setup.sh" ]; then \
		"$(CLAUDE_GLOBAL)/engineering/setup.sh" "$(CURDIR)"; \
	else \
		echo "$(RED)‚ùå Engineering Ethos setup script not found$(NC)"; \
		echo "$(YELLOW)Run: ~/.claude/engineering/setup.sh $(CURDIR)$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)‚úÖ Engineering Ethos setup complete$(NC)"

.PHONY: install
install: setup ## Install dependencies and setup project
	@echo "$(BLUE)üì¶ Installing dependencies...$(NC)"
	@if [ -f "package.json" ]; then \
		npm install; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è No package.json found - skipping npm install$(NC)"; \
	fi

# Validation and Quality
.PHONY: validate
validate: validate-syntax validate-tests validate-docs validate-patterns ## Run complete validation suite
	@echo "$(GREEN)‚úÖ All validations passed$(NC)"

.PHONY: validate-syntax
validate-syntax: ## Validate syntax of all source files
	@echo "$(BLUE)üîß Validating syntax...$(NC)"
	@find . -name "*.js" -not -path "./node_modules/*" -exec node -c {} \; 2>/dev/null || (echo "$(RED)‚ùå JavaScript syntax errors detected$(NC)" && exit 1)
	@find . -name "*.json" -not -path "./node_modules/*" -exec python -m json.tool {} /dev/null \; 2>/dev/null || (echo "$(RED)‚ùå JSON syntax errors detected$(NC)" && exit 1)
	@echo "$(GREEN)‚úÖ Syntax validation passed$(NC)"

.PHONY: validate-tests
validate-tests: ## Validate test configuration and coverage
	@echo "$(BLUE)üß™ Validating test configuration...$(NC)"
	@if [ -f "package.json" ]; then \
		if grep -q '"test"' package.json; then \
			echo "$(GREEN)‚úÖ Test script configured$(NC)"; \
		else \
			echo "$(YELLOW)‚ö†Ô∏è No test script in package.json$(NC)"; \
		fi; \
		if grep -q '"test:smoke"' package.json; then \
			echo "$(GREEN)‚úÖ Smoke tests configured$(NC)"; \
		else \
			echo "$(YELLOW)‚ö†Ô∏è No smoke tests configured$(NC)"; \
		fi; \
		if grep -q '"test:critical"' package.json; then \
			echo "$(GREEN)‚úÖ Critical tests configured$(NC)"; \
		else \
			echo "$(YELLOW)‚ö†Ô∏è No critical tests configured$(NC)"; \
		fi; \
	else \
		echo "$(RED)‚ùå package.json not found$(NC)"; \
		exit 1; \
	fi

.PHONY: validate-docs
validate-docs: ## Validate documentation completeness
	@echo "$(BLUE)üìã Validating documentation...$(NC)"
	@MISSING=0; \
	for doc in LEARNINGS.md README.md; do \
		if [ ! -f "$$doc" ]; then \
			echo "$(RED)‚ùå Missing: $$doc$(NC)"; \
			MISSING=$$((MISSING + 1)); \
		else \
			LINES=$$(wc -l < "$$doc" 2>/dev/null || echo "0"); \
			if [ "$$LINES" -lt 5 ]; then \
				echo "$(YELLOW)‚ö†Ô∏è $$doc exists but appears minimal ($$LINES lines)$(NC)"; \
			else \
				echo "$(GREEN)‚úÖ $$doc exists with content ($$LINES lines)$(NC)"; \
			fi; \
		fi; \
	done; \
	if [ $$MISSING -gt 0 ]; then \
		echo "$(RED)‚ùå $$MISSING required documentation files missing$(NC)"; \
		exit 1; \
	fi

.PHONY: validate-patterns
validate-patterns: ## Validate pattern extraction integration
	@echo "$(BLUE)üéØ Validating pattern integration...$(NC)"
	@if [ -f "$(CLAUDE_GLOBAL)/patterns/registry.json" ]; then \
		PROJECT_COUNT=$$(jq -r '.projects | length' "$(CLAUDE_GLOBAL)/patterns/registry.json" 2>/dev/null || echo "0"); \
		echo "$(GREEN)‚úÖ Pattern registry found with $$PROJECT_COUNT projects$(NC)"; \
		if jq -r ".projects[] | select(.name == \"$(PROJECT_NAME)\") | .name" "$(CLAUDE_GLOBAL)/patterns/registry.json" 2>/dev/null | grep -q "$(PROJECT_NAME)"; then \
			echo "$(GREEN)‚úÖ Current project registered in pattern system$(NC)"; \
		else \
			echo "$(YELLOW)‚ö†Ô∏è Current project not in pattern registry$(NC)"; \
			echo "$(YELLOW)   Run: make extract-patterns$(NC)"; \
		fi; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è Pattern registry not found$(NC)"; \
		echo "$(YELLOW)   Initialize with: $(CLAUDE_GLOBAL)/scripts/extract-local-patterns.sh .$(NC)"; \
	fi

# Testing
.PHONY: test
test: ## Run all tests
	@echo "$(BLUE)üß™ Running all tests...$(NC)"
	@if [ -f "package.json" ] && grep -q '"test"' package.json; then \
		npm test; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è No test configuration found$(NC)"; \
		exit 1; \
	fi

.PHONY: test-smoke
test-smoke: ## Run smoke tests (fast validation)
	@echo "$(BLUE)üí® Running smoke tests...$(NC)"
	@if [ -f "package.json" ] && grep -q '"test:smoke"' package.json; then \
		npm run test:smoke; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è No smoke tests configured$(NC)"; \
		echo "$(YELLOW)   Add 'test:smoke' script to package.json$(NC)"; \
	fi

.PHONY: test-critical
test-critical: ## Run critical path tests
	@echo "$(BLUE)üö® Running critical tests...$(NC)"
	@if [ -f "package.json" ] && grep -q '"test:critical"' package.json; then \
		npm run test:critical; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è No critical tests configured$(NC)"; \
		echo "$(YELLOW)   Add 'test:critical' script to package.json$(NC)"; \
	fi

.PHONY: test-coverage
test-coverage: ## Run tests with coverage analysis
	@echo "$(BLUE)üìä Running test coverage analysis...$(NC)"
	@if [ -f "package.json" ]; then \
		if npm test -- --coverage 2>/dev/null; then \
			echo "$(GREEN)‚úÖ Coverage analysis complete$(NC)"; \
			if [ -d "coverage" ]; then \
				echo "$(BLUE)üìã Coverage report: coverage/lcov-report/index.html$(NC)"; \
			fi; \
		else \
			echo "$(YELLOW)‚ö†Ô∏è Coverage analysis not available$(NC)"; \
			npm test; \
		fi; \
	else \
		echo "$(RED)‚ùå package.json not found$(NC)"; \
		exit 1; \
	fi

# Development Workflows
.PHONY: investigate
investigate: ## Start critical bug investigation workflow
	@echo "$(BLUE)üïµÔ∏è Starting critical bug investigation...$(NC)"
	@ISSUE="$(filter-out $@,$(MAKECMDGOALS))"; \
	if [ -z "$$ISSUE" ]; then \
		echo "$(RED)‚ùå Usage: make investigate ISSUE='description'$(NC)"; \
		exit 1; \
	fi; \
	echo "$(BLUE)üìã Issue: $$ISSUE$(NC)"; \
	echo "$(BLUE)üìñ Consulting LEARNINGS.md...$(NC)"; \
	if [ -f "LEARNINGS.md" ]; then \
		echo "$(GREEN)‚úÖ LEARNINGS.md found - review similar patterns$(NC)"; \
		grep -n -i -A 2 -B 2 "$$(echo $$ISSUE | cut -d' ' -f1)" LEARNINGS.md || echo "$(YELLOW)‚ö†Ô∏è No similar patterns found$(NC)"; \
	else \
		echo "$(RED)‚ùå LEARNINGS.md not found$(NC)"; \
	fi; \
	if [ -f "$(CLAUDE_GLOBAL)/engineering/test-harness.sh" ]; then \
		"$(CLAUDE_GLOBAL)/engineering/test-harness.sh" investigation "$$ISSUE"; \
	fi

.PHONY: fix-critical
fix-critical: ## Apply critical bug fix workflow
	@echo "$(BLUE)üö® Starting critical bug fix workflow...$(NC)"
	@$(MAKE) validate-tests
	@$(MAKE) test-critical
	@echo "$(GREEN)‚úÖ Ready for critical bug fix implementation$(NC)"

.PHONY: extract-patterns
extract-patterns: ## Extract patterns to global registry
	@echo "$(BLUE)üéØ Extracting patterns to global registry...$(NC)"
	@if [ -f "$(CLAUDE_GLOBAL)/scripts/extract-local-patterns.sh" ]; then \
		"$(CLAUDE_GLOBAL)/scripts/extract-local-patterns.sh" "$(CURDIR)"; \
	else \
		echo "$(RED)‚ùå Pattern extraction script not found$(NC)"; \
		exit 1; \
	fi

# Git and Deployment
.PHONY: pre-commit
pre-commit: ## Run pre-commit validation
	@echo "$(BLUE)üîç Running pre-commit validation...$(NC)"
	@if [ -f "$(CLAUDE_GLOBAL)/engineering/pre-commit-hook.sh" ]; then \
		"$(CLAUDE_GLOBAL)/engineering/pre-commit-hook.sh"; \
	else \
		echo "$(RED)‚ùå Pre-commit hook not found$(NC)"; \
		echo "$(YELLOW)Run: make setup$(NC)"; \
		exit 1; \
	fi

.PHONY: install-hooks
install-hooks: ## Install git hooks
	@echo "$(BLUE)ü™ù Installing git hooks...$(NC)"
	@if [ -d ".git" ]; then \
		if [ -f "$(CLAUDE_GLOBAL)/engineering/pre-commit-hook.sh" ]; then \
			cp "$(CLAUDE_GLOBAL)/engineering/pre-commit-hook.sh" ".git/hooks/pre-commit"; \
			chmod +x ".git/hooks/pre-commit"; \
			echo "$(GREEN)‚úÖ Pre-commit hook installed$(NC)"; \
		else \
			echo "$(RED)‚ùå Pre-commit hook not found$(NC)"; \
			exit 1; \
		fi; \
	else \
		echo "$(RED)‚ùå Not a git repository$(NC)"; \
		exit 1; \
	fi

.PHONY: commit-template
commit-template: ## Show commit message template
	@echo "$(BLUE)üìù Commit Message Template:$(NC)"
	@echo ""
	@echo "$(GREEN)Type(scope): Brief description$(NC)"
	@echo ""
	@echo "$(YELLOW)Longer description explaining the change and its context.$(NC)"
	@echo "$(YELLOW)Reference LEARNINGS.md patterns when applicable.$(NC)"
	@echo ""
	@echo "$(PURPLE)LEARNINGS.md: Applied pattern X.Y - <pattern description>$(NC)"
	@echo "$(PURPLE)STANDARDS_COMPLIANCE: <compliance notes>$(NC)"
	@echo "$(PURPLE)PREVENTION: <prevention mechanisms added>$(NC)"
	@echo ""
	@echo "$(BLUE)Example:$(NC)"
	@echo "fix(layout): Fix pane width calculation in focus mode"
	@echo ""
	@echo "Resolves issue where 2-pane focus mode incorrectly calculated"
	@echo "minimum widths, causing layout instability."
	@echo ""
	@echo "LEARNINGS.md: Applied pattern 4.6 - State validation checks"
	@echo "PREVENTION: Added width calculation validation tests"

# Status and Monitoring
.PHONY: status
status: ## Show project engineering status
	@echo "$(BLUE)üìä Engineering Status for $(PROJECT_NAME):$(NC)"
	@echo ""
	@echo "$(GREEN)Documentation:$(NC)"
	@[ -f "LEARNINGS.md" ] && echo "  ‚úÖ LEARNINGS.md ($$(wc -l < LEARNINGS.md) lines)" || echo "  ‚ùå LEARNINGS.md missing"
	@[ -f "README.md" ] && echo "  ‚úÖ README.md ($$(wc -l < README.md) lines)" || echo "  ‚ùå README.md missing"
	@echo ""
	@echo "$(GREEN)Testing:$(NC)"
	@[ -f "package.json" ] && grep -q '"test"' package.json && echo "  ‚úÖ Test script configured" || echo "  ‚ùå No test script"
	@[ -d "test" ] && echo "  ‚úÖ Test directory exists ($$(find test -name '*.js' | wc -l) files)" || echo "  ‚ùå No test directory"
	@echo ""
	@echo "$(GREEN)Git:$(NC)"
	@[ -f ".git/hooks/pre-commit" ] && echo "  ‚úÖ Pre-commit hook installed" || echo "  ‚ùå Pre-commit hook not installed"
	@echo ""
	@echo "$(GREEN)Patterns:$(NC)"
	@if [ -f "$(CLAUDE_GLOBAL)/patterns/registry.json" ]; then \
		if jq -r ".projects[] | select(.name == \"$(PROJECT_NAME)\") | .name" "$(CLAUDE_GLOBAL)/patterns/registry.json" 2>/dev/null | grep -q "$(PROJECT_NAME)"; then \
			echo "  ‚úÖ Registered in global pattern registry"; \
		else \
			echo "  ‚ùå Not registered in pattern registry"; \
		fi; \
	else \
		echo "  ‚ùå No global pattern registry found"; \
	fi

# Cleanup and Maintenance
.PHONY: clean
clean: ## Clean build artifacts and temporary files
	@echo "$(BLUE)üßπ Cleaning build artifacts...$(NC)"
	@rm -rf node_modules/.cache coverage .nyc_output dist build
	@echo "$(GREEN)‚úÖ Cleanup complete$(NC)"

.PHONY: clean-deep
clean-deep: clean ## Deep clean including dependencies
	@echo "$(BLUE)üßπ Deep cleaning...$(NC)"
	@rm -rf node_modules package-lock.json
	@echo "$(GREEN)‚úÖ Deep cleanup complete$(NC)"

# Development Environment
.PHONY: dev-setup
dev-setup: install install-hooks ## Complete development setup
	@echo "$(GREEN)‚úÖ Development environment setup complete$(NC)"
	@$(MAKE) status

# Allow string arguments to be passed to investigate target
%:
	@:

# Prevent make from interpreting arguments as filenames
.PHONY: $(filter-out help setup install validate validate-syntax validate-tests validate-docs validate-patterns test test-smoke test-critical test-coverage investigate fix-critical extract-patterns pre-commit install-hooks commit-template status clean clean-deep dev-setup, $(MAKECMDGOALS))

# Default pattern-based rules for common engineering workflows
pattern-%.md:
	@echo "$(BLUE)üìã Creating $@ from pattern template...$(NC)"
	@if [ -f "$(CLAUDE_GLOBAL)/templates/$@" ]; then \
		cp "$(CLAUDE_GLOBAL)/templates/$@" "$@"; \
		echo "$(GREEN)‚úÖ $@ created from template$(NC)"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è Template for $@ not found, creating minimal version$(NC)"; \
		echo "# $@" > "$@"; \
		echo "" >> "$@"; \
		echo "This file was auto-generated by Engineering Ethos." >> "$@"; \
		echo "Please update with actual content." >> "$@"; \
	fi